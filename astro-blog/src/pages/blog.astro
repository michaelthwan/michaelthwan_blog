---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// Get all posts sorted by date (newest first)
const allPosts = (await getCollection('posts')).sort((a, b) => {
  return new Date(b.data.published).getTime() - new Date(a.data.published).getTime();
});

// Split by category
const mlPosts = allPosts.filter(post => post.data.category === 'ml');
const devPosts = allPosts.filter(post => post.data.category === 'dev');

// Format date for display
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'short', day: 'numeric' };
  return date.toLocaleDateString('en-US', options).replace(',', '.');
}
---

<Base title="Michael Wan Interactive Insights" isHomepage={true}>
    <Header />

    <!-- Two Column Layout -->
    <main class="index-columns l-page">
        <!-- ML Column -->
        <section class="index-column ml-column">
            <div class="column-header">
                <h2>Machine Learning</h2>
                <p class="column-desc">Paper explainers, architectures, and the math behind modern AI</p>
            </div>
            <div class="posts-list">
                {mlPosts.map(post => (
                    <article class="post-preview">
                        <div class="post-meta">
                            <span class="post-date">{formatDate(post.data.published)}</span>
                            <div class="post-tags">
                                {post.data.tags.map(tag => (
                                    <span class={`tag ${tag}`}>{tag.charAt(0).toUpperCase() + tag.slice(1)}</span>
                                ))}
                            </div>
                        </div>
                        <a href={`/posts/${post.slug}`} class="post-link">
                            <div class="post-thumbnail">
                                <div class="thumbnail-placeholder">
                                    {post.data.thumbnail ? (
                                        <img src={post.data.thumbnail} alt={post.data.title} />
                                    ) : (
                                        <svg viewBox="0 0 200 120" class="thumbnail-svg">
                                            <rect x="40" y="30" width="120" height="60" fill="#f5f5f5" stroke="#ddd" stroke-width="2" rx="4"/>
                                            <text x="100" y="65" text-anchor="middle" font-size="12" fill="#999">Article</text>
                                        </svg>
                                    )}
                                </div>
                            </div>
                            <div class="post-content">
                                <h3 class="post-title">{post.data.title}</h3>
                                <p class="post-authors">
                                    {post.data.authors.slice(0, 3).map((author, i) => (
                                        <Fragment>
                                            <span set:html={author.replace(' ', '&nbsp;')} />
                                            {i < Math.min(post.data.authors.length, 3) - 1 && ', '}
                                        </Fragment>
                                    ))}
                                    {post.data.authors.length > 3 && <em>, et&nbsp;al.</em>}
                                </p>
                                <p class="post-abstract">{post.data.abstract}</p>
                            </div>
                        </a>
                    </article>
                ))}
                {mlPosts.length === 0 && (
                    <p class="empty-column">No articles yet</p>
                )}
            </div>
        </section>

        <!-- Dev Column -->
        <section class="index-column dev-column">
            <div class="column-header">
                <h2>Development</h2>
                <p class="column-desc">Tools, workflows, and practical engineering insights</p>
            </div>
            <div class="posts-list">
                {devPosts.map(post => (
                    <article class="post-preview">
                        <div class="post-meta">
                            <span class="post-date">{formatDate(post.data.published)}</span>
                            <div class="post-tags">
                                {post.data.tags.map(tag => (
                                    <span class={`tag ${tag}`}>{tag.charAt(0).toUpperCase() + tag.slice(1)}</span>
                                ))}
                            </div>
                        </div>
                        <a href={`/posts/${post.slug}`} class="post-link">
                            <div class="post-thumbnail">
                                <div class="thumbnail-placeholder">
                                    {post.data.thumbnail ? (
                                        <img src={post.data.thumbnail} alt={post.data.title} />
                                    ) : (
                                        <svg viewBox="0 0 200 120" class="thumbnail-svg">
                                            <rect x="40" y="30" width="120" height="60" fill="#f5f5f5" stroke="#ddd" stroke-width="2" rx="4"/>
                                            <text x="100" y="65" text-anchor="middle" font-size="12" fill="#999">Article</text>
                                        </svg>
                                    )}
                                </div>
                            </div>
                            <div class="post-content">
                                <h3 class="post-title">{post.data.title}</h3>
                                <p class="post-authors">
                                    {post.data.authors.slice(0, 3).map((author, i) => (
                                        <Fragment>
                                            <span set:html={author.replace(' ', '&nbsp;')} />
                                            {i < Math.min(post.data.authors.length, 3) - 1 && ', '}
                                        </Fragment>
                                    ))}
                                    {post.data.authors.length > 3 && <em>, et&nbsp;al.</em>}
                                </p>
                                <p class="post-abstract">{post.data.abstract}</p>
                            </div>
                        </a>
                    </article>
                ))}
                {devPosts.length === 0 && (
                    <p class="empty-column">No articles yet</p>
                )}
            </div>
        </section>
    </main>

    <Footer />
</Base>
